{% if request.page_type == 'product' %}

<section
  id="recently-viewed-{{ section.id }}"
  class="recently-viewed-section {{ section.settings.custom_class }}"
  data-section-id="{{ section.id }}"
  data-product-id="{{ product.id }}"
  data-products-to-show="{{ section.settings.limit }}"
  data-search-url="{{ routes.search_url }}?section_id={{ section.id }}&type=product&q="
>
  <div class="container section-{{ section.id }}-padding">

    {% if section.settings.title != blank %}
      <h2>{{ section.settings.title }}</h2>
    {% endif %}

    <ul class="recently-viewed-list" data-products-container>
      <!-- products injected here -->
    </ul>

  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const section = document.querySelector('#recently-viewed-{{ section.id }}');
  if (!section) return;

  const currentId = section.dataset.productId;
  const limit = parseInt(section.dataset.productsToShow, 10);
  const searchUrl = section.dataset.searchUrl;
  const storageKey = 'recently_viewed_ids';

  /* ---------- STORE PRODUCT ID ---------- */
  let ids = JSON.parse(localStorage.getItem(storageKey)) || [];
  ids = ids.filter(id => id !== currentId);
  ids.unshift(currentId);
  ids = ids.slice(0, limit);
  localStorage.setItem(storageKey, JSON.stringify(ids));

  /* ---------- BUILD SEARCH QUERY ---------- */
  const query = ids
    .filter(id => id !== currentId)
    .map(id => `id:${id}`)
    .join(' OR ');

  if (!query) return;

  fetch(searchUrl + encodeURIComponent(query))
    .then(res => res.text())
    .then(html => {
      const doc = new DOMParser().parseFromString(html, 'text/html');
      const products = doc.querySelectorAll('[data-recent-product]');

      const container = section.querySelector('[data-products-container]');
      products.forEach(p => container.appendChild(p));

      if (products.length === 0) {
        section.style.display = 'none';
      }
    });
});
</script>




{% endif %}
{% schema %}
{
  "name": "Recently Viewed Products",
  "settings": [
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Recently viewed"
    },
    {
      "type": "range",
      "id": "limit",
      "label": "Maximum products",
      "min": 2,
      "max": 12,
      "step": 1,
      "default": 8
    },
    {
      "type": "header",
      "content": "Section padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top padding",
      "default": 40
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom padding",
      "default": 52
    },
    {
      "type": "header",
      "content": "Dynamic Option"
    },
    {
      "type": "text",
      "id": "custom_class",
      "label": "Custom class"
    }
  ],
  "presets": [
    {
      "name": "Recently Viewed Products",
      "category": "Products"
    }
  ]
}
{% endschema %}
