{% comment %}
  Password Page Section – Enhanced & Configurable
{% endcomment %}

{{ 'password.css' | asset_url | stylesheet_tag }}
{{ 'flipdown.css' | asset_url | stylesheet_tag }}

<section class="password-section {% if section.settings.default_theme == 'light' %}light-theme{% else %}dark-theme{% endif %}">
  <div class="password-background">
    {% if section.settings.background_image %}
      {{ section.settings.background_image | img_url: 'master' | img_tag: alt: 'Password Background', class: 'password-bg-image' }}
    {% endif %}
  </div>

  <div class="container-fluid">
    <div class="inner-section">

      {% if section.settings.show_logo %}
        <div class="site-logo">
          {% if settings.logo %}
            <a href="{{ shop.url }}">
              {{ settings.logo | img_url: 'master' | img_tag: alt: shop.name, class: 'shop-logo' }}
            </a>
          {% else %}
            <a href="{{ shop.url }}">{{ shop.name }}</a>
          {% endif %}
        </div>
      {% endif %}

      {% if section.settings.show_wave_text %}
        <div class="text-wave">
          <div class="waviy">
            {% assign text = section.settings.wave_text | split: '' %}
            {% for char in text %}
              <span style="--i:{{ forloop.index }}">{{ char }}</span>
            {% endfor %}
          </div>
        </div>
      {% endif %}

      {% if section.settings.show_countdown %}
        <div class="launch-date">
          <h3>{{ section.settings.countdown_title }}</h3>
          <div id="flipdown" class="flipdown"></div>
        </div>
        <div class="launch-ended-content" style="display:none;">
        <h2>{{ section.settings.after_launch_title }}</h2>

          {% if section.settings.after_launch_button_link != blank %}
            <a href="{{ section.settings.after_launch_button_link }}" class="button">
              {{ section.settings.after_launch_button_text }}
            </a>
          {% endif %}
        </div>

      {% endif %}

      {% if section.settings.show_password_form %}
        <div class="password-form-wrapper">
          <h4>{{ section.settings.password_title }}</h4>

          {% if section.settings.password_message %}
            <div class="password-message">
              {{ section.settings.password_message }}
            </div>
          {% endif %}
          {% if shop.password_message %}
            <p>{{ shop.password_message }}</p>
          {% endif %}

          {% form 'storefront_password' %}
            {% if form.errors %}
              {{ form.errors | default_errors }}
            {% endif %}

            <label for="password-input">
              {{ 'password.password' | t }}
            </label>

            <input type="password" name="password" id="password-input">

            <button type="submit">
              {{ 'password.enter' | t }}
            </button>
          {% endform %}
        </div>
      {% endif %}

      {% if section.settings.show_notify %}
        <div class="notify-me">
          <h4>{{ section.settings.notify_title }}</h4>

          {% form 'customer', id: 'notify-launch' %}
            <input type="hidden" name="contact[tags]" value="notify-launch">

            <input
              type="email"
              name="contact[email]"
              placeholder="{{ section.settings.notify_placeholder }}"
              required
            >

            <button type="submit">
              {{ section.settings.notify_button }}
            </button>

            {% if form.posted_successfully? %}
              <p class="success-message">{{ section.settings.notify_success }}</p>
            {% endif %}
          {% endform %}
        </div>
      {% endif %}

    </div>
  </div>
</section>

<script src="{{ 'flipdown.min.js' | asset_url }}" defer></script>

<script>
document.addEventListener('DOMContentLoaded', function () {

  /* ----------------------------------
    Prevent duplicate execution
  ---------------------------------- */
  if (window.__passwordPageInitialized) return;
  window.__passwordPageInitialized = true;

  var section = document.querySelector('.password-section');
  if (!section) return;

  var themeInterval = null;

  /* ----------------------------------
    COUNTDOWN (UTC BASED)
  ---------------------------------- */
  {% if section.settings.show_countdown %}

    var utcDate = "{{ section.settings.launch_date }}";
    var utcTime = "{{ section.settings.launch_time }}";

    if (utcDate && utcTime && typeof FlipDown !== 'undefined') {

      var utcTimestamp = Date.parse(utcDate + 'T' + utcTime + ':00Z') / 1000;
      var now = Math.floor(Date.now() / 1000);

      function handleLaunchEnd() {
        section.classList.add('launch-ended');

        var countdown = section.querySelector('.launch-date');
        if (countdown) countdown.style.display = 'none';

        var launchContent = section.querySelector('.launch-ended-content');
        if (launchContent) launchContent.style.display = 'block';

        var passwordForm = section.querySelector('.password-form-wrapper');
        if (passwordForm) passwordForm.style.display = 'none';

        var notifyForm = section.querySelector('.notify-me');
        if (notifyForm) notifyForm.style.display = 'none';

        if (themeInterval) {
          clearInterval(themeInterval);
        }
      }

      /* If already past launch time */
      if (now >= utcTimestamp) {
        handleLaunchEnd();
        return;
      }

      /* Initialize FlipDown */
      new FlipDown(utcTimestamp, 'flipdown')
        .start()
        .ifEnded(() => {
          console.log('Launch time reached');
          handleLaunchEnd();
        });

      /* ----------------------------------
        THEME AUTO SWITCH (EVERY 1 MINUTE)
      ---------------------------------- */
      {% if section.settings.auto_toggle_theme %}

        // Normalize initial theme
        if (
          !section.classList.contains('light-theme') &&
          !section.classList.contains('dark-theme')
        ) {
          section.classList.add('dark-theme');
        }

        themeInterval = setInterval(function () {
          if (section.classList.contains('launch-ended')) {
            clearInterval(themeInterval);
            return;
          }

          section.classList.toggle('light-theme');
          section.classList.toggle('dark-theme');
        }, 60000); // ✅ 1 minute

      {% endif %}

    }

  {% endif %}

});
</script>


{% schema %}
{
  "name": "Password Page",
  "settings": [
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "Background Image"
    },

    {
      "type": "select",
      "id": "default_theme",
      "label": "Default Theme",
      "options": [
        { "value": "dark", "label": "Dark" },
        { "value": "light", "label": "Light" }
      ],
      "default": "dark"
    },

    {
      "type": "checkbox",
      "id": "auto_toggle_theme",
      "label": "Auto toggle theme every minute",
      "default": false
    },

    {
      "type": "checkbox",
      "id": "show_logo",
      "label": "Show logo",
      "default": true
    },

    {
      "type": "checkbox",
      "id": "show_wave_text",
      "label": "Show wave text",
      "default": true
    },
    {
      "type": "text",
      "id": "wave_text",
      "label": "Wave Text",
      "default": "comingsoon"
    },

    {
      "type": "checkbox",
      "id": "show_countdown",
      "label": "Show countdown timer",
      "default": true
    },
    {
      "type": "text",
      "id": "countdown_title",
      "label": "Countdown Title",
      "default": "Launching In"
    },
    {
      "type": "text",
      "id": "launch_date",
      "label": "Launch Date (UTC)",
      "default": "2026-02-01",
      "info": "Format: YYYY-MM-DD (UTC)"
    },
    {
      "type": "text",
      "id": "launch_time",
      "label": "Launch Time (UTC)",
      "default": "12:00",
      "info": "24h format: HH:MM (UTC)"
    },
    {
      "type": "header",
      "content": "After Launch"
    },
    {
      "type": "text",
      "id": "after_launch_title",
      "label": "After launch title",
      "default": "We are live!"
    },
    {
      "type": "text",
      "id": "after_launch_button_text",
      "label": "Button text",
      "default": "Shop Now"
    },
    {
      "type": "url",
      "id": "after_launch_button_link",
      "label": "Button link"
    },
    {
      "type": "checkbox",
      "id": "show_password_form",
      "label": "Show password form",
      "default": true
    },
    {
      "type": "text",
      "id": "password_title",
      "label": "Password Title",
      "default": "This shop is private"
    },
    {
      "type": "richtext",
      "id": "password_message",
      "label": "Password Message"
    },

    {
      "type": "checkbox",
      "id": "show_notify",
      "label": "Show notify email form",
      "default": true
    },
    {
      "type": "text",
      "id": "notify_title",
      "label": "Notify Title",
      "default": "Get notified when we launch"
    },
    {
      "type": "text",
      "id": "notify_placeholder",
      "label": "Email Placeholder",
      "default": "Enter your email"
    },
    {
      "type": "text",
      "id": "notify_button",
      "label": "Button Text",
      "default": "Notify Me"
    },
    {
      "type": "text",
      "id": "notify_success",
      "label": "Success Message",
      "default": "Thanks! We’ll notify you."
    }
  ]
}
{% endschema %}
